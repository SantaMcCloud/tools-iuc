<tool id="sample_grouping" name="Sample grouping" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <macros>
        <token name="@TOOL_VERSION@">1.0.0</token>
        <token name="@VERSION_SUFFIX@">0</token>
        <token name="@PROFILE@">25.0</token>
    </macros>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">sample_grouping</requirement>
    </requirements>
    <command detect_errors="exit_code">
        <![CDATA[

            #if $metadata
                group_col=`awk -v OFS=',' -F"\t" 'NR == 1 { print $group_col}' '$metadata'` &&
            #end if

            mdkir 'output' 'samples' &&

            #for $sample in $samples
                ln -s '$sample.forward' 'samples/$samples.forward.element_identifier' &&
                ln -s '$sample.reverse' 'samples/$samples.reverse.element_identifier' &&
            #end for

            reorder_reads.py
            'samples'
            'output'
            #if $metadata:
                --metadata '$metadata'
                --group_col \$group_col
            #end if
            --sep '$sep'
            --forward_suffix '$forward_suffix'
            --reverse_suffix '$reverse_suffix'


        ]]>
    </command>
    <inputs>
        <param name="samples" type="data_collection" collection_type="list:paired" format="fastq,fastq.gz" label="Input paired sample(s) read(s) collection"/>
        <param argument="--metadata" type="data" multiple="false" format="tabular" optional="true" label="Input metadata table file" help="If no metadata table is set as input this tool will merge all forward/reverse reads from the sample together into one forward/reverse read!"/>
        <param argument="--sep" type="select" label="Select seperator for metadata file">
            <option value="," selected="true">,</option>
            <option value="\t">Tab</option>
            <option value=" ">Space</option>
            <option value=";">;</option> 
            <option value=":">:</option>
        </param>
        <param argument="--group_col" type="data_column" data_ref="metadata" use_header_names="true" label="Select column where the groups are stated" help="The metadata file should contain two columns, one with the sample names and one where each of the sample should be group to. Look at the help section for more information!"/>
        <param argument="--forward_suffix" type="text" value="_forward" label="Set the suffix used for the forward sample names">
            <validator type="regex" message="no valid input">_[0-9a-zA-Z]+</validator>
        </param>
        <param argument="--reverse_suffix" type="text" value="_reverse" label="Set the suffix used for the reverse sample names">
            <validator type="regex" message="no valid input">_[0-9a-zA-Z]+</validator>
        </param>
    </inputs>
    <outputs>
        <collection name="merged_samples" type="list:paired" label="${tool.name} on ${on_string}: MERGED SAMPLES">
            <discover_datasets pattern="(?P&lt;identifier_0&gt;[^_]+)_\d+.fastq_(?P&lt;identifier_1&gt;[^_]+)\.fastq" ext="fastq" directory="output"/>
            <discover_datasets pattern="(?P&lt;identifier_0&gt;[^_]+)_\d+.fastq.gz_(?P&lt;identifier_1&gt;[^_]+)\.fastq.gz" ext="fastq.gz" directory="output"/>
        </collection>
    </outputs>
</tool>