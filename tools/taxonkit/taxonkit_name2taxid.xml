<tool id="name2taxid" name="Name2taxid" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Convert taxon names to TaxIds</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="biotools"/>
    <expand macro="requirements" />
    <command detect_errors="exit_code">
    <![CDATA[

		mkdir -p ../home/.taxonkit &&

		#if $data.is_select == 'his':
			#for $f in $data.files:
				ln -s '$f' '../home/.taxonkit/$f.element_identifier' &&
			#end for
		#else:
			ln -s '$ncbi.fields.path/names.dmp' '../home/.taxonkit/names.dmp' &&
			ln -s '$ncbi.fields.path/merged.dmp' '../home/.taxonkit/merged.dmp' &&
			ln -s '$ncbi.fields.path/nodes.dmp' '../home/.taxonkit/nodes.dmp' &&
			ln -s '$ncbi.fields.path/delnodes.dmp' '../home/.taxonkit/delnodes.dmp' &&
		#end if

        taxonkit name2taxid 
        --name-field $name_field
        $sci_name
        $show_rank
        '$input'
        > '$output'
    ]]>
    </command>
    <inputs>
        <param name="input" type="data" format="tabular" label="Input file"
            help="Input any tsv file where the NCBI names are written. You can also use a .txt but only one name per row!" />
        <param argument="--name-field" type="data_column" data_ref="input" label="Select column with the names"
            help="Select the colum where the name are written" />
        <param argument="--sci-name" type="boolean" falsevalue="" truevalue="--sci-name" checked="false" label="Only searching scientific names"/>
        <param argument="--show-rank" type="boolean" falsevalue="" truevalue="--show-rank" checked="false" label="Show rank" />
		<conditional name="data">
			<param name="is_select" type="select" label="Use either a DM or history files for the ncbi database">
				<option value="dm">Data manager</option>
				<option value="his">History</option>
			</param>
			<when value="dm">
				<param name="ncbi" type="select" label="NCBI database"
					help="Choose NCBI database version" >
					<options from_data_table="ncbi_taxonomy">
						<validator message="No NCBI database is available" type="no_options"/>
					</options>
				</param>
			</when>
			<when value="his">
				<param name="files" format="tabular" type="data" multiple="true"
                    label="Input .dmp files"
                    help="To use the NCBI database we need to provide followed .dmp files: nodes.dmp, names.dmp, delnodes.dmp and merged.dmp. You can get the via download of this file **ftp://ftp.ncbi.nih.gov/pub/taxonomy/taxdump.tar.gz** and unzip it!" />
			</when>
		</conditional>
	</inputs>
    <outputs>
        <data name="output" format="tabular" label="Names2taxID" />
    </outputs>
    <tests>
        <test>
            <param name="input" value="name2taxid_test1.tsv" ftype="tabular"/>
			<param name="name_field" value="1" />
			<conditional name="data">
				<param name="is_select" value="dm"/> 
				<param name="ncbi" value="test-db-tox" />
			</conditional>
            <output name="output" file="name2taxid_result1.tsv"/>
        </test>
        <test>
            <param name="input" value="name2taxid_test2.tsv" ftype="tabular" />
            <conditional name="data">
				<param name="is_select" value="dm"/> 
				<param name="ncbi" value="test-db-tox" />
			</conditional>
			<param name="name_field" value="2" />
			<output name="output" file="name2taxid_result2.tsv"/>
		</test>
		<test>
			<param name="input" value="name2taxid_test3.txt" ftype="tabular"/>
			<param name="name_field" value="1" />
			<conditional name="data">
				<param name="is_select" value="his"/> 
				<param name="files" value="test-db/nodes.dmp,test-db/merged.dmp,test-db/names.dmp,test-db/delnodes.dmp" ftype="tabular"/>
			</conditional>
			<param name="sci_name" value="true"/>
			<param name="show_rank" value="true"/>
			<output name="output" file="name2taxid_result3.tsv"/>
		</test>
    </tests>
    <help>
    <![CDATA[
		
			This tool can convert any NCBI name to there taxid. Simply input any tsv or txt file into here and state the column where the name are written.

			.. class:: infomark

			Example

			::
			 Homo sapiens
			 Akkermansia muciniphila ATCC BAA-835
			 Akkermansia muciniphila 
			 Mouse Intracisternal A-particle 
	]]>
    </help>
    <expand macro="citations" />
</tool>