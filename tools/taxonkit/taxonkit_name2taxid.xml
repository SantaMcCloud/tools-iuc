<tool id="name2taxid" name="Name2taxid" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Convert taxon names to TaxIds</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="biotools"/>
    <expand macro="requirements" />
    <command detect_errors="exit_code">
    <![CDATA[

		mkdir -p ../home/.taxonkit &&

		#if $data.is_select == 'his':
			#for $f in $data.files:
				ln -s '$f' '../home/.taxonkit/$f.element_identifier' &&
			#end for
		#else:
			ln -s '$ncbi.fields.path/names.dmp' '../home/.taxonkit/names.dmp' &&
			ln -s '$ncbi.fields.path/merged.dmp' '../home/.taxonkit/merged.dmp' &&
			ln -s '$ncbi.fields.path/nodes.dmp' '../home/.taxonkit/nodes.dmp' &&
			ln -s '$ncbi.fields.path/delnodes.dmp' '../home/.taxonkit/delnodes.dmp' &&
		#end if

        taxonkit name2taxid 
        --name-field $name_field
        $sci_name
        $show_rank
        '$input'
        > '$output'
    ]]>
    </command>
    <inputs>
        <param name="input" type="data" format="tabular" label="Input file"
            help="Input any tsv file where the NCBI names are written. You can also use a .txt but only one name per row!" />
        <param argument="--name-field" type="data_column" data_ref="input" label="Select column with the names"
            help="Select the colum where the name are written" />
        <param argument="--sci-name" type="boolean" falsevalue="" truevalue="--sci-name" checked="false" label="Only searching scientific names"
			help="With this option on a non scientific name will not yield any taxid since the tool will ignore them in the search. NOTE: The non scientific names will still be in the output but without any taxid! "/>
        <param argument="--show-rank" type="boolean" falsevalue="" truevalue="--show-rank" checked="false" label="Show rank" 
			help="Use this option to yield the rank of the name in the output. For an example look at the help section!"/>
		<conditional name="data">
			<param name="is_select" type="select" label="Use either a cached ncbi database or upload from history">
				<option value="dm">Cached database</option>
				<option value="his">History</option>
			</param>
			<when value="dm">
				<param name="ncbi" type="select" label="NCBI database"
					help="Choose NCBI database version" >
					<options from_data_table="ncbi_taxonomy">
						<validator message="No NCBI database is available" type="no_options"/>
					</options>
				</param>
			</when>
			<when value="his">
				<param name="files" format="tabular" type="data" multiple="true"
                    label="Input .dmp files"
                    help="To use the NCBI database we need to provide followed .dmp files: nodes.dmp, names.dmp, delnodes.dmp and merged.dmp. You can get them via download of this file **ftp://ftp.ncbi.nih.gov/pub/taxonomy/taxdump.tar.gz** and unzip it!" />
			</when>
		</conditional>
	</inputs>
    <outputs>
        <data name="output" format="tabular" label="Names2taxID" />
    </outputs>
    <tests>
        <test>
            <param name="input" value="name2taxid_test1.tsv" ftype="tabular"/>
			<param name="name_field" value="1" />
			<param name="sci-name" value="True"/>
			<conditional name="data">
				<param name="is_select" value="dm"/> 
				<param name="ncbi" value="test-db-tox" />
			</conditional>
            <output name="output" file="name2taxid_result1.tsv"/>
        </test>
        <test>
            <param name="input" value="name2taxid_test2.tsv" ftype="tabular" />
			<param name="show-rank" value="True"/>
            <conditional name="data">
				<param name="is_select" value="dm"/> 
				<param name="ncbi" value="test-db-tox" />
			</conditional>
			<param name="name_field" value="2" />
			<output name="output" file="name2taxid_result2.tsv"/>
		</test>
		<test>
			<param name="input" value="name2taxid_test3.txt" ftype="tabular"/>
			<param name="name_field" value="1" />
			<conditional name="data">
				<param name="is_select" value="his"/> 
				<param name="files" value="test-db/nodes.dmp,test-db/merged.dmp,test-db/names.dmp,test-db/delnodes.dmp" ftype="tabular"/>
			</conditional>
			<param name="sci_name" value="true"/>
			<param name="show_rank" value="true"/>
			<output name="output" file="name2taxid_result3.tsv"/>
		</test>
    </tests>
    <help>
    <![CDATA[
		
			This tool can convert a NCBI name to its corresponding taxid. Simply input a tsv or txt file and state the column where the name are written.

			.. class:: infomark

			Example

			::

				Homo sapiens
				Akkermansia muciniphila ATCC BAA-835
				Akkermansia muciniphila 
				Mouse Intracisternal A-particle 

			**sci_name option**
			.. class:: infomark

			For example the name Enterococcus coli is not a scientific scientific name which mean with the option you can remove it from the querey to find a taxid to it but it will be still in the output while for example Drosophila is a scientific name which mean that this will always be search in the querey even if the option is on or off.

			**show_rank option**
			..class:: infomark

			Here is an example of the output if you use the option:

			::

				Homo sapiens	9606	species
				Akkermansia muciniphila ATCC BAA-835	349741	strain
				Akkermansia muciniphila	239935	species
				Mouse Intracisternal A-particle	11932	species
			
			without this option the output will be:

			::

				Homo sapiens	9606
				Akkermansia muciniphila ATCC BAA-835	349741
				Akkermansia muciniphila	239935
				Mouse Intracisternal A-particle	11932
	]]>
    </help>
    <expand macro="citations" />
</tool>