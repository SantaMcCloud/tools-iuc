<tool id="ncbi-gtdb_map" name="NCBI-GTDB map" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Map taxonomic classifications between the NCBI and GTDB taxonomies</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code">
        <![CDATA[

        mkdir output &&

        #for $f in $metadata:
            ln -s '$f' '$f.element_identifier' &&
        #end for

        ncbi-gtdb_map.py
        #if $mode == 'gtdb':
            -q gtdb_taxonomy
        #end if
        '${names}'
        #for $f in $metadata:
            '$f.element_identifier'
        #end for
        --completeness ${completeness}
        --contamination ${contamination}
        --fraction ${fraction}
        --max_tips ${max_tips}
        --column ${column}
        ${header}
        #if ${prefix}:
            --prefix ${prefix}
        #end if
        ${no_prefix}
        -o output
        --procs \${GALAXY_SLOTS:-8}

        ]]>
    </command>
    <inputs>
        <param name="names" type="data" format="tabular" label="File with the names" help="You can either have a file the NCBI names or the GTDB names"/>
        <param name="metadata" type="data" multiple="true" format="tabular" label="Compressed metadata files from GTDB" help="Input the compressed bac120 and/or ar53 metadata file here which can be downloaded from GTDB. The link it stated in the help section. The current version which GDTB-Tk is using on galaxy is 214.1 it is recommanded to use them here too!"/>
        <param name="mode" type="select" label="Select the type of mapping" help="Choose if you want to map NCBI agaisnt GTDB or the other way around">
            <option value="ncbi">NCBI to GTDB</option>
            <option value="gtdb">GTDB to NCBI</option>
        </param>
        <param argument="--completeness" type="float" value="50.0" label="Completeness filter"
            help="Only include GTDB genomes who have bigger or equal CheckM completeness"/>
        <param argument="--contamination" type="float" value="5.0" label="Contamination filter"
            help="Only include GTDB genomes who have a smaller CheckM contamination" />
        <param argument="--fraction" type="float" min="0.0" max="1.0" value="0.9" label="Homogeneity of LCA"
            help="Change the homogeneity of LCA in order to be used"/>
        <param argument="--max-tips" type="integer" value="100" min="1" label="Max. number of tips"
            help="Select the number of tips used for LCA determination" />
        <param argument="--column" type="data_column" data_ref="names" label="Select the column with the names" />
        <param argument="--header" type="boolean" truevalue="--header" falsevalue="" checked="false" label="Header row in the input"
            help="Check if the input file has a header to so the program will skip it" />
        <param argument="--prefix" type="text" value="" label="Include a prefix"
            help="Add a prefix if the names for example the GTDB name are state without it. Example: s__ as prefix wich will be added in all names. In GTDB there are different prefixes which can be used but this tool only can work with one added prefix" />
        <param argument="--no-prefix" type="boolean" truevalue="--no-prefix" falsevalue="" checked="false" label="No prefix"
            help="Check here if the names doesn't have a prefix like 's__xyz'. NOTE: Only names without prefix will be used then when a name still have it it will be mapped to unclassified!" />
    </inputs>
    <outputs>
        <data name="output_gtdb" format="tabular" label="${tool.name}: GTDB_to_NCBI" from_work_dir="output/taxonomy_map_summary.tsv">
            <filter>mode and 'gtdb' in mode </filter>
        </data>
        <data name="output_ncbi" format="tabular" label="${tool.name}: NCBI_to_GTDB" from_work_dir="output/taxonomy_map_summary.tsv">
            <filter>mode 'ncbi' in mode </filter>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="mode" value="gtdb"/>
            <param name="names" value="gtdb_test.tsv"/>
            <param name="metadata" value="ar_test.tsv,bac_test.tsv"/>
            <param name="completeness" value="1.0"/>  
            <param name="contamination" value="1.0"/>
            <param name="fraction" value="0.2"/>
            <param name="max_tips" value="10"/>
            <param name="column" value="2"/>
            <output name="output_gtdb">
                <assert_contents>
                    <has_n_lines n="6" delta="1"/>
                    <has_text text="unclassified" n="4"/>
                    <not_has_text text="test1"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="mode" value="ncbi"/>
            <param name="names" value="ncbi_test.tsv"/>
            <param name="metadata" value="ar_test.tsv,bac_test.tsv"/>
            <param name="no_prefix" value="true"/>
            <output name="output_ncbi">
                <assert_contents>
                    <has_n_lines n="5" delta="1"/>
                    <has_text text="unclassified" n="3"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="mode" value="ncbi"/>
            <param name="names" value="ncbi_test_prefix.tsv"/>
            <param name="metadata" value="ar_test.tsv,bac_test.tsv"/>
            <param name="header" value="true"/>
            <output name="output_ncbi">
                <assert_contents>
                    <has_n_lines n="5" delta="1"/>
                    <has_text text="unclassified" n="3"/>
                    <not_has_text text="TEST HEADER!!!!"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help>
        <![CDATA[
        .. class:: infomark

            **Where to download the metadata**

            The metadata can be download here from `GTDB <https://data.gtdb.ecogenomic.org/releases/>`_. Remeber to check the current version of the datamanger which GTDB release is used there since it is recommanded to use the same version aswell.

            **What does this tool**

            This tool was desinged to map the GTDB taxonomy to the NCBI taxonomy since both are using different ID systems.
            This means this tool map either GTDB names to the NCBI names or the other way around. If the names contains prefixes like *s__* the maped name also will contain there corresponded prefix. If you use the namse without prefix then the maped names also dont contain there prefixes.
        ]]>
    </help>
    <expand macro="citations"/>
</tool>
